# Global Payment Fraud Detection System - Database Schema

## Database Architecture Overview

### Database Type: **Azure Cosmos DB (NoSQL Document Database)**

**Note:** This system uses **Azure Cosmos DB**, NOT SQL Server. Cosmos DB is a globally distributed, multi-model NoSQL database service that provides:
- Horizontal scalability
- Low latency (single-digit millisecond response times)
- Multi-region replication
- Flexible schema with JSON documents
- Automatic indexing

### Database Configuration
- **Database Name**: `FraudDetection` (configurable via `Cosmos:DatabaseName` in appsettings.json)
- **Connection**: Configured via `Cosmos:ConnectionString` or `COSMOS_CONNECTION_STRING` environment variable
- **Partition Strategy**: Each collection uses appropriate partition keys for optimal performance

---

## Collections (Containers) Schema

### 1. Transactions Collection

**Container Name**: `Transactions`  
**Partition Key**: `/UserId`  
**Purpose**: Stores all payment transactions with fraud detection results

#### Schema
```json
{
  "transactionId": "string (Primary Key)",
  "userId": "string (Partition Key)",
  "amount": "decimal",
  "currency": "string (default: USD)",
  "timestamp": "datetime (UTC)",
  "ipAddress": "string",
  "deviceId": "string",
  "merchantId": "string",
  "paymentGateway": "string (Stripe|PayPal|Braintree|AuthorizeNet)",
  "paymentMethod": "string",
  "status": "string (PENDING|APPROVED|DECLINED)",
  "country": "string",
  "city": "string",
  "latitude": "double",
  "longitude": "double",
  "deviceType": "string",
  "browser": "string",
  "operatingSystem": "string",
  "isFraudulent": "boolean",
  "fraudScore": "double (0.0-1.0)",
  "metadata": {
    "key1": "value1",
    "key2": "value2"
  }
}
```

#### Indexes
- `/userId` (Partition Key)
- `/timestamp` (Range Index - for time-based queries)
- `/isFraudulent` (Boolean Index)
- `/fraudScore` (Range Index)
- `/paymentGateway` (String Index)

#### Sample Document
```json
{
  "transactionId": "txn_a1b2c3d4e5f6",
  "userId": "user_12345",
  "amount": 299.99,
  "currency": "USD",
  "timestamp": "2025-10-16T19:30:00Z",
  "ipAddress": "192.168.1.100",
  "deviceId": "device_xyz789",
  "merchantId": "merchant_abc123",
  "paymentGateway": "Stripe",
  "paymentMethod": "credit_card",
  "status": "APPROVED",
  "country": "USA",
  "city": "New York",
  "latitude": 40.7128,
  "longitude": -74.0060,
  "deviceType": "mobile",
  "browser": "Chrome",
  "operatingSystem": "iOS",
  "isFraudulent": false,
  "fraudScore": 0.23,
  "metadata": {
    "orderId": "order_999",
    "productCategory": "electronics"
  }
}
```

---

### 2. UserProfiles Collection

**Container Name**: `UserProfiles`  
**Partition Key**: `/userId`  
**Purpose**: Stores user behavioral profiles and historical patterns for fraud detection

#### Schema
```json
{
  "id": "string (Cosmos DB ID)",
  "userId": "string (Partition Key)",
  "totalTransactions": "int",
  "avgAmount": "decimal",
  "totalSpent": "decimal",
  "lastLocation": "string",
  "deviceFingerprint": "string",
  "suspiciousFlags": "int",
  "usedIpAddresses": ["string", "string", ...],
  "usedDevices": ["string", "string", ...],
  "firstTransactionDate": "datetime",
  "lastTransactionDate": "datetime",
  "declinedTransactions": "int",
  "chargebackCount": "int",
  "velocityScore": "double",
  "riskScore": "double (0.0-1.0)",
  "isBlacklisted": "boolean"
}
```

#### Indexes
- `/userId` (Partition Key)
- `/riskScore` (Range Index)
- `/isBlacklisted` (Boolean Index)
- `/lastTransactionDate` (Range Index)

#### Sample Document
```json
{
  "id": "profile_abc123",
  "userId": "user_12345",
  "totalTransactions": 47,
  "avgAmount": 125.50,
  "totalSpent": 5898.50,
  "lastLocation": "New York, USA",
  "deviceFingerprint": "fp_xyz789",
  "suspiciousFlags": 2,
  "usedIpAddresses": [
    "192.168.1.100",
    "10.0.0.50"
  ],
  "usedDevices": [
    "device_xyz789",
    "device_abc456"
  ],
  "firstTransactionDate": "2024-01-15T10:30:00Z",
  "lastTransactionDate": "2025-10-16T19:30:00Z",
  "declinedTransactions": 3,
  "chargebackCount": 0,
  "velocityScore": 0.45,
  "riskScore": 0.28,
  "isBlacklisted": false
}
```

---

### 3. FraudAlerts Collection

**Container Name**: `FraudAlerts`  
**Partition Key**: `/userId`  
**Purpose**: Stores fraud alerts generated by the detection system

#### Schema
```json
{
  "alertId": "string (Primary Key)",
  "transactionId": "string",
  "userId": "string (Partition Key)",
  "amount": "decimal",
  "fraudProbability": "double (0.0-1.0)",
  "alertType": "string",
  "severity": "string (LOW|MEDIUM|HIGH|CRITICAL)",
  "createdAt": "datetime (UTC)",
  "status": "string (UNRESOLVED|RESOLVED|FALSE_POSITIVE)",
  "assignedTo": "string",
  "resolution": "string",
  "resolvedAt": "datetime (nullable)",
  "reasons": ["string", "string", ...]
}
```

#### Indexes
- `/userId` (Partition Key)
- `/status` (String Index)
- `/severity` (String Index)
- `/createdAt` (Range Index)
- `/fraudProbability` (Range Index)

#### Sample Document
```json
{
  "alertId": "alert_f1e2d3c4b5a6",
  "transactionId": "txn_suspicious_001",
  "userId": "user_67890",
  "amount": 2500.00,
  "fraudProbability": 0.94,
  "alertType": "HIGH_VALUE_TRANSACTION",
  "severity": "CRITICAL",
  "createdAt": "2025-10-16T20:15:00Z",
  "status": "UNRESOLVED",
  "assignedTo": "analyst_jane_doe",
  "resolution": "",
  "resolvedAt": null,
  "reasons": [
    "Geographic mismatch: Nigeria to USA",
    "First international transaction",
    "High-risk country",
    "New account (< 24 hours)"
  ]
}
```

---

### 4. AlertRules Collection

**Container Name**: `AlertRules`  
**Partition Key**: `/id`  
**Purpose**: Stores configurable fraud detection rules

#### Schema
```json
{
  "id": "string (Primary Key & Partition Key)",
  "name": "string",
  "description": "string",
  "condition": "string (rule expression)",
  "threshold": "decimal",
  "action": "string (ALERT|BLOCK|REVIEW)",
  "isActive": "boolean",
  "createdAt": "datetime (UTC)",
  "updatedAt": "datetime (nullable)"
}
```

#### Sample Document
```json
{
  "id": "rule_001",
  "name": "High Value International Wire",
  "description": "Alert on international wire transfers > $10,000 from elderly customers",
  "condition": "Amount > 10000 AND IsInternational = true AND CustomerAge >= 65",
  "threshold": 10000.00,
  "action": "BLOCK",
  "isActive": true,
  "createdAt": "2025-01-15T10:00:00Z",
  "updatedAt": "2025-10-01T14:30:00Z"
}
```

---

### 5. Webhooks Collection

**Container Name**: `Webhooks`  
**Partition Key**: `/id`  
**Purpose**: Stores webhook configurations for fraud event notifications

#### Schema
```json
{
  "id": "string (Primary Key & Partition Key)",
  "name": "string",
  "url": "string (webhook endpoint)",
  "events": ["string", "string", ...],
  "secret": "string (HMAC secret for validation)",
  "isActive": "boolean",
  "createdAt": "datetime (UTC)",
  "lastTriggeredAt": "datetime (nullable)"
}
```

#### Sample Document
```json
{
  "id": "webhook_001",
  "name": "E-Commerce Platform Webhook",
  "url": "https://api.myecommerce.com/fraud-alerts",
  "events": [
    "fraud.detected",
    "transaction.declined",
    "alert.critical"
  ],
  "secret": "whsec_a1b2c3d4e5f6g7h8i9j0",
  "isActive": true,
  "createdAt": "2025-09-01T12:00:00Z",
  "lastTriggeredAt": "2025-10-16T20:15:00Z"
}
```

---

### 6. ApiKeys Collection

**Container Name**: `ApiKeys`  
**Partition Key**: `/id`  
**Purpose**: Stores API keys for external system authentication

#### Schema
```json
{
  "id": "string (Primary Key & Partition Key)",
  "name": "string",
  "key": "string (encrypted API key)",
  "keyPrefix": "string (default: fpd_pk_)",
  "createdAt": "datetime (UTC)",
  "lastUsedAt": "datetime (nullable)",
  "isActive": "boolean",
  "environment": "string (development|staging|production)"
}
```

#### Sample Document
```json
{
  "id": "apikey_001",
  "name": "Production API Key - Partner XYZ",
  "key": "fpd_pk_live_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6",
  "keyPrefix": "fpd_pk_",
  "createdAt": "2025-08-15T09:00:00Z",
  "lastUsedAt": "2025-10-16T19:45:00Z",
  "isActive": true,
  "environment": "production"
}
```

---

## Supporting Data Models (Not Stored Separately)

These models are used for processing but not stored as separate collections:

### BehavioralData
```json
{
  "userId": "string",
  "ipAddress": "string",
  "geoLocation": {
    "country": "string",
    "city": "string",
    "latitude": "double",
    "longitude": "double",
    "ispName": "string",
    "isProxy": "boolean",
    "isVpn": "boolean",
    "isTor": "boolean",
    "riskScore": "int"
  },
  "deviceInfo": {
    "deviceId": "string",
    "deviceType": "string",
    "browser": "string",
    "browserVersion": "string",
    "operatingSystem": "string",
    "screenResolution": "string",
    "timeZone": "string",
    "language": "string",
    "cookiesEnabled": "boolean",
    "javaScriptEnabled": "boolean"
  },
  "velocity": {
    "transactionsLast1Hour": "int",
    "transactionsLast24Hours": "int",
    "transactionsLast7Days": "int",
    "amountLast1Hour": "decimal",
    "amountLast24Hours": "decimal",
    "uniqueDevicesLast24Hours": "int",
    "uniqueIpsLast24Hours": "int",
    "velocityScore": "double"
  },
  "anomalyFlags": ["string", "string", ...],
  "riskScore": "double"
}
```

### PaymentGatewayTransaction
```json
{
  "gatewayTransactionId": "string",
  "gateway": "string",
  "gatewayType": "Stripe|PayPal|Braintree|AuthorizeNet",
  "customerId": "string",
  "amount": "decimal",
  "currency": "string",
  "status": "string",
  "paymentMethodId": "string",
  "paymentMethodType": "string",
  "rawData": {
    "key": "value"
  },
  "createdAt": "datetime",
  "failoverReason": "string (nullable)"
}
```

### FraudScoreResponse
```json
{
  "transactionId": "string",
  "fraudProbability": "double (0.0-1.0)",
  "isFraudulent": "boolean",
  "decision": "string (APPROVED|DECLINED|PENDING|REVIEW)",
  "reason": "string",
  "processedAt": "datetime",
  "riskFactors": {
    "geolocation": 0.45,
    "velocity": 0.78,
    "behavioral": 0.62,
    "deviceFingerprint": 0.31
  },
  "reviewStatus": "string (AUTO|MANUAL)",
  "reviewedBy": "string",
  "reviewedAt": "datetime (nullable)"
}
```

---

## Entity Relationships

### Primary Relationships

```
UserProfiles (1) ──── (N) Transactions
    └── userId

UserProfiles (1) ──── (N) FraudAlerts
    └── userId

Transactions (1) ──── (1) FraudAlerts
    └── transactionId

AlertRules (N) ──── (N) FraudAlerts
    └── Rule evaluation triggers alerts

Webhooks (N) ──── (N) FraudAlerts
    └── Webhooks triggered by alerts

ApiKeys (N) ──── (N) Transactions
    └── API keys used to submit transactions
```

---

## Query Patterns & Indexing Strategy

### Common Query Patterns

1. **Get User Transactions**
   ```sql
   SELECT * FROM c WHERE c.userId = @userId ORDER BY c.timestamp DESC
   ```

2. **Get Unresolved Alerts**
   ```sql
   SELECT * FROM c WHERE c.status = 'UNRESOLVED' ORDER BY c.createdAt DESC
   ```

3. **Get High-Risk Users**
   ```sql
   SELECT * FROM c WHERE c.riskScore >= @threshold ORDER BY c.riskScore DESC
   ```

4. **Get Fraudulent Transactions in Date Range**
   ```sql
   SELECT * FROM c 
   WHERE c.isFraudulent = true 
   AND c.timestamp >= @startDate 
   AND c.timestamp <= @endDate 
   ORDER BY c.timestamp DESC
   ```

5. **Get Alerts by Severity**
   ```sql
   SELECT * FROM c WHERE c.severity = @severity ORDER BY c.createdAt DESC
   ```

### Indexing Recommendations

1. **Transactions Collection**
   - Composite index: `/userId, /timestamp` (for user transaction history)
   - Composite index: `/isFraudulent, /timestamp` (for fraud reports)
   - Range index: `/fraudScore` (for scoring queries)

2. **FraudAlerts Collection**
   - Composite index: `/status, /createdAt` (for dashboard queries)
   - Composite index: `/severity, /createdAt` (for critical alerts)
   - Composite index: `/userId, /status` (for user alert history)

3. **UserProfiles Collection**
   - Range index: `/riskScore` (for high-risk user identification)
   - Composite index: `/isBlacklisted, /lastTransactionDate` (for security checks)

---

## Partition Strategy

### Why These Partition Keys?

1. **Transactions: `/userId`**
   - Ensures all user transactions are co-located
   - Enables efficient user transaction history queries
   - Provides even distribution (many users)

2. **UserProfiles: `/userId`**
   - Natural partition for user-specific data
   - One-to-one mapping with users
   - Efficient lookups and updates

3. **FraudAlerts: `/userId`**
   - Co-locates alerts with user data
   - Enables efficient user alert history
   - Supports analytical queries

4. **AlertRules, Webhooks, ApiKeys: `/id`**
   - These are configuration entities (low volume)
   - Random GUID distribution prevents hot partitions
   - Simple lookup by ID

---

## Data Retention & Compliance

### Recommended Retention Policies

1. **Transactions**: 7 years (regulatory compliance)
2. **FraudAlerts**: 7 years (audit trail)
3. **UserProfiles**: Active + 3 years post-dormancy
4. **AlertRules**: Active indefinitely, archive inactive
5. **Webhooks**: Active indefinitely
6. **ApiKeys**: Active + 1 year post-revocation

### Compliance Considerations

- **PCI-DSS**: Sensitive payment data should be tokenized (not stored)
- **GDPR**: User data can be deleted upon request (right to be forgotten)
- **SOC 2**: Audit trail maintained for all fraud decisions
- **AML/BSA**: Transaction records retained for regulatory reporting

---

## Cosmos DB Configuration

### Connection Configuration (appsettings.json)
```json
{
  "Cosmos": {
    "ConnectionString": "AccountEndpoint=https://your-cosmosdb.documents.azure.com:443/;AccountKey=...",
    "DatabaseName": "FraudDetection"
  }
}
```

### Container Configuration

#### Recommended Throughput (RU/s)

- **Transactions**: 4000 RU/s (autoscale: 400-4000)
- **UserProfiles**: 2000 RU/s (autoscale: 200-2000)
- **FraudAlerts**: 2000 RU/s (autoscale: 200-2000)
- **AlertRules**: 400 RU/s (manual scale)
- **Webhooks**: 400 RU/s (manual scale)
- **ApiKeys**: 400 RU/s (manual scale)

#### Time-to-Live (TTL) Settings

- **Transactions**: No TTL (manual archival)
- **FraudAlerts**: No TTL (regulatory requirements)
- **UserProfiles**: No TTL (active user profiles)
- **Session/Cache data**: 24 hours (if implemented)

---

## Database Setup Script (Azure CLI)

```bash
# Create Cosmos DB account
az cosmosdb create \
  --name fraud-detection-cosmos \
  --resource-group fraud-detection-rg \
  --default-consistency-level Session \
  --enable-automatic-failover true

# Create database
az cosmosdb sql database create \
  --account-name fraud-detection-cosmos \
  --name FraudDetection \
  --resource-group fraud-detection-rg

# Create containers with partition keys
az cosmosdb sql container create \
  --account-name fraud-detection-cosmos \
  --database-name FraudDetection \
  --name Transactions \
  --partition-key-path /userId \
  --throughput 4000

az cosmosdb sql container create \
  --account-name fraud-detection-cosmos \
  --database-name FraudDetection \
  --name UserProfiles \
  --partition-key-path /userId \
  --throughput 2000

az cosmosdb sql container create \
  --account-name fraud-detection-cosmos \
  --database-name FraudDetection \
  --name FraudAlerts \
  --partition-key-path /userId \
  --throughput 2000

az cosmosdb sql container create \
  --account-name fraud-detection-cosmos \
  --database-name FraudDetection \
  --name AlertRules \
  --partition-key-path /id \
  --throughput 400

az cosmosdb sql container create \
  --account-name fraud-detection-cosmos \
  --database-name FraudDetection \
  --name Webhooks \
  --partition-key-path /id \
  --throughput 400

az cosmosdb sql container create \
  --account-name fraud-detection-cosmos \
  --database-name FraudDetection \
  --name ApiKeys \
  --partition-key-path /id \
  --throughput 400
```

---

## Summary

### Database Type
✅ **Azure Cosmos DB** (NoSQL Document Database)  
❌ **NOT SQL Server**

### Total Collections: **6**
1. Transactions
2. UserProfiles
3. FraudAlerts
4. AlertRules
5. Webhooks
6. ApiKeys

### Key Features
- **Globally distributed** with multi-region replication
- **Low latency** (< 10ms read/write)
- **Automatic indexing** of all properties
- **Flexible schema** (JSON documents)
- **Horizontal scalability** with partitioning
- **Built-in backup** and disaster recovery
